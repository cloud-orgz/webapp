name: Build and Deploy GCP Image

on:
  push:
    branches:
      - main

permissions:
  contents: read
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Start MySQL service
        run: |
          sudo systemctl start mysql
          sudo systemctl status mysql --no-pager || true

      - name: Create MySQL Database
        env:
          GIT_MYSQL_USER: ${{ secrets.GIT_MYSQL_USER }}
          GIT_MYSQL_PASSWORD: ${{ secrets.GIT_MYSQL_PASSWORD }}
        run: |
          mysql -u "${GIT_MYSQL_USER}" -p"${GIT_MYSQL_PASSWORD}" -e "CREATE DATABASE IF NOT EXISTS cloud;"

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Create GCP Credentials File
        env:
          GCP_CREDENTIALS: ${{ secrets.CREDS_JSON }}
        run: |
          mkdir -p src/main/resources
          echo "$GCP_CREDENTIALS" > src/main/resources/creds.json

      - name: Test with Maven
        run: mvn -B test
        env:
          SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/cloud
          SPRING_DATASOURCE_USERNAME: ${{ secrets.GIT_MYSQL_USER }}
          SPRING_DATASOURCE_PASSWORD: ${{ secrets.GIT_MYSQL_PASSWORD }}
          LOGFILE_PATH: target/logs
          GCP_PROJECTID: ${{ secrets.GCP_PROJECTID }}
          TOPIC_NAME: ${{ secrets.TOPIC_NAME }}
          CREDS_JSON: ${{ github.workspace }}/src/main/resources/creds.json

      - name: Build with Maven
        run: mvn -B clean package -DskipTests

      - name: Authenticate to Google Cloud (Image project)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud CLI (Image project)
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Setup packer
        uses: hashicorp/setup-packer@v2
        with:
          version: 1.8.6

      - name: Build Custom GCP Image with Packer
        id: packer_build
        shell: bash
        run: |
          set -euo pipefail
          cd packer-dir
          packer init .
          packer_output=$(packer build -machine-readable \
            -var "artifact_path=${{ github.workspace }}/target/assignment1-1.0.0.jar" \
            -var "project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var "zone=${{ secrets.GCP_ZONE }}" \
            . | tee /tmp/packer.log)
          
          IMAGE_ID=$(grep -E 'artifact,0,id' /tmp/packer.log | tail -n 1 | awk -F, '{print $6}' | awk -F: '{print $NF}')
          if [ -z "${IMAGE_ID}" ]; then
            echo "Packer build failed or image ID was not found."
            exit 1
          fi
          echo "Image ID: $IMAGE_ID"
          echo "IMAGE_ID=$IMAGE_ID" >> $GITHUB_ENV

      - name: Authenticate to Google Cloud (VM/MIG project)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_VM }}

      - name: Set up gcloud CLI (VM/MIG project)
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Prepare Startup Script
        shell: bash
        run: |
          cat <<'EOF' > startup-script.sh
          #!/bin/bash
          set -euo pipefail
          ENV_PATH="/opt/webapp/.env"
          sudo mkdir -p /opt/webapp
          sudo rm -f "$ENV_PATH"
          sudo touch "$ENV_PATH"
          
          sudo gsutil cp "gs://${BUCKET_NAME}/creds.json" /opt/webapp/creds.json
          
          {
            echo "DB_USERNAME=${DB_USER}"
            echo "DB_PASSWORD=${DB_PASS}"
            echo "DB_HOSTNAME=${DB_IP}"
            echo "DB_NAME=${DB_NAME}"
            echo "LOGFILE_PATH=/var/logs/webapp"
            echo "GCP_PROJECTID=${GCP_PROJECT_ID}"
            echo "TOPIC_NAME=${TOPIC_NAME_META}"
            echo "CREDS_JSON=/opt/webapp/creds.json"
          } | sudo tee "$ENV_PATH" >/dev/null
          
          sudo chown csye6225:csye6225 "$ENV_PATH" /opt/webapp/creds.json
          sudo chmod 640 "$ENV_PATH" /opt/webapp/creds.json
          
          sudo systemctl daemon-reload || true
          sudo systemctl restart javaapp.service || true
          EOF
          chmod +x startup-script.sh
        env:
          BUCKET_NAME: ${{ secrets.BUCKET_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASS: ${{ secrets.DB_PASS }}
          DB_IP: ${{ secrets.DB_IP }}
          DB_NAME: ${{ secrets.DB_NAME }}
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          TOPIC_NAME_META: ${{ secrets.TOPIC_NAME_META }}

      - name: Create New Instance Template with Latest Image
        shell: bash
        run: |
          set -euo pipefail
          TEMPLATE_NAME="webapp-vm-template-$(date +%Y%m%d%H%M%S)"
          
          gcloud compute instance-templates create "$TEMPLATE_NAME" \
            --project="${{ secrets.GCP_PROJECT_ID }}" \
            --machine-type="${{ secrets.GCP_MACH }}" \
            --network="projects/${{ secrets.GCP_PROJECT_ID }}/global/networks/${{ secrets.VPC_NETWORK_NAME }}" \
            --subnet="projects/${{ secrets.GCP_PROJECT_ID }}/regions/${{ secrets.GCP_REGION }}/subnetworks/${{ secrets.SUBNETWORK_NAME }}" \
            --image-project="${{ secrets.GCP_PROJECT_ID }}" \
            --image="${IMAGE_ID}" \
            --boot-disk-kms-key="${{ secrets.CMEK_VM_ID }}" \
            --tags="webapp-vm-template,allow-app-traffic,deny-all-traffic,allow-ssh-traffic,load-balancer" \
            --metadata-from-file startup-script=startup-script.sh \
            --service-account="${{ secrets.SERVICE_ACCOUNT_EMAIL }}" \
            --scopes="https://www.googleapis.com/auth/cloud-platform"
          
          echo "TEMPLATE_NAME=$TEMPLATE_NAME" >> $GITHUB_ENV
          echo "Template Name: $TEMPLATE_NAME"

      - name: Update Managed Instance Group to Use New Template
        shell: bash
        run: |
          set -euo pipefail
          gcloud compute instance-groups managed set-instance-template "${{ secrets.MIG_NAME }}" \
            --project="${{ secrets.GCP_PROJECT_ID }}" \
            --template="${TEMPLATE_NAME}" \
            --region="${{ secrets.GCP_REGION }}"

      - name: Start a basic rolling update
        shell: bash
        run: |
          set -euo pipefail
          gcloud compute instance-groups managed rolling-action start-update "${{ secrets.MIG_NAME }}" \
            --project="${{ secrets.GCP_PROJECT_ID }}" \
            --region="${{ secrets.GCP_REGION }}" \
            --version="template=${TEMPLATE_NAME}"

      - name: Monitor update status until version target is reached
        shell: bash
        run: |
          set -euo pipefail
          while true; do
            updateStatus=$(gcloud compute instance-groups managed describe "${{ secrets.MIG_NAME }}" \
              --project="${{ secrets.GCP_PROJECT_ID }}" \
              --region="${{ secrets.GCP_REGION }}" \
              --format="value(status.versionTarget.isReached)")
            if [[ "$updateStatus" == "true" || "$updateStatus" == "True" ]]; then
              echo "Update has successfully reached the version target."
              break
            fi
            echo "Update is still in progress..."
            sleep 30
          done
